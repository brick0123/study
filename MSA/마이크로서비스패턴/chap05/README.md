# chap05

# 비즈니스 로직 설계

---

## 비즈니스 로직 구성 패턴

비즈니스 로직은 `절차적 트랜잭션 스크립트 패턴` 과 `객체 지향적 도메인 모델 패턴` 으로 구분된다.

- 트랜잭션 스크립트 패턴
특정 비즈니스의 관련된 로직들을 단일 프로시저로 구성한 것.
- 도메인 모델 패턴
각 객체가 수행할 책임을 분담해서 협력한다.

---

## 도메인 주도 설계 개요

DDD에서 도메인 모델을 구축할 때 쓰이는 것.

- 엔티티: 영속성을 가진 객체.
- 벨류 오브젝트: 값을 모아놓은 객체.
- 팩토리: 정적 메서드로 구현.
- 리포지토리: 엔티티를 저장하는 DB 접근 로직을 캡슐화한 객체
- 서비스: 비즈니스 로직 구현 객체

---

## 애그리거트

경계가 불분명하면 MSA에서 문제가 발생할 가능성이 높다. 애그리거트는 한 단위로 취급 가능한 경계 도메인 객체들이다. 하나의 루트 엔티티와 기타 엔티티 + 밸류 객체로 구성된다.

### 애그리거트는 일관된 경계

업데이트 작업은 애그리거트 루트에서 호출되기 때문에 불변 값이 강제된다. 
예컨대 직접 주문 수량을 수정하지 않고, 반드시 주문 애그리거트를 루트에 메서드를 호출하기 때문에, 최소 주문량 같은 불변 값이 강제된다.

### 애그리거트 규칙

1. 애그리거트 루트만 참조해라
2. 애그리거트 참조는 기본키를 사용해라 (db상을 얘기하는건가?)
3. 하나의 트랜잭션으로 하나의 애그리거트를 생성/수정하라

### 애그리거트 크기

애그리거트는 크면 클 수록 추후 분해의 걸림돌이 될 수 있다. 필요에 의해서 크게 만드는 것도 좋지만, 가능한 작으면 작을 수록 좋다.

---

## 도메인 이벤트 발행

DDD 맥락에서 도메인 이벤트는 애그리거트에 발생한 사건이며 대부분 상태 변경을 나타낸다. 애그리거트는 상태가 전이될 때마다 이에 관련된 컨슈머에 이벤트를 발행한다.

### 도메인 이벤트 생성

개념적으로 도메인 이벤트는 애그리거트가 발행한다. 애그리거트가 메세징 API를 직접 호출하는 것도 가능하지만, 인프라와 비즈니스 로직이 뒤엉킬 수도 있다. 따라서 애그리거트와 호출하는 서비스를 분리하는 것이 좋다.