# Chap04 - Saga

핵심 주제

- 분산 환경에서 트랜잭션 관리
- Saga 패턴이란?
- Saga의 특징

---

## MSA에서 트랜잭션 관리

MSA 환경에서 트랜잭션 관리가 어려운 이유

- 분산 트랜잭션의 정의

**분산 트랜잭션**([영어](https://ko.wikipedia.org/wiki/%EC%98%81%EC%96%B4): Distributed transaction)은 2개 그 이상의 [네트워크](https://ko.wikipedia.org/wiki/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC) 상의 시스템 간의 트랜잭션이다. 일반적으로 시스템은 **트랜잭션 리소스**(transaction resource)의 역할을 하고, **트랜잭션 매니저**(transaction manager)는 이러한 리소스에 관련된 모든 동작에 대해 트랜잭션의 생성 및 관리를 담당한다. 분산 트랜잭션은 다른 [트랜잭션](https://ko.wikipedia.org/wiki/%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4_%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98)처럼 4가지 [ACID](https://ko.wikipedia.org/wiki/ACID)(원자성, 일관성, 고립성, 지속성) 속성을 갖추어야 하며, 여기에서 원자성은 일의 단위(UOW)를 위해 all-or-nothing 결과를 보증해야 한다.
- [https://ko.wikipedia.org/wiki/분산_트랜잭션](https://ko.wikipedia.org/wiki/%EB%B6%84%EC%82%B0_%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98)
- 분산 트랜잭션의 필요성
    
    msa 환경에서는 여러 서비스의 데이터에 접근해야 하는 경우가 많다. 서비스마다 DB가 따로 있기 때문에, 여러 DB에 걸쳐 데이터 일관성을 유지할 수 있는 방법이 필요하다.
    

### 사가 패턴

비동기 메세징을 이용하여 편성한 로컬 트랜잭션.  (MSA에서 분산 트랜잭션 없이, 데이터 일관성을 유지하는 매커니즘??). 각 서비스마다 커맨드 사가를 정의한다. 사가는 일련의 로컬 트랜잭션이며, 각 로컬 트랜잭션은 ACID 프레임워크/라이브러리를 이용해서 각 서비스별 데이터를 업데이트한다.

1. 사가 첫 단계 시작
2. 로컬 트랜잭션 완료
3. 다음 로컬 트랜잭션

- 사가와 ACID의 차이점
    - 사가에는 **I(Isolation)**이 없다.
    - 사가는 로컬트랜잭션 변경분을 커밋하므로 **보상 트랜잭션**을 걸어 롤백해야한다.

- 사가는 **보상 트랜잭션**으로 롤백한다.
    
    x번째 사가 트랜잭션이 실패하면 x-1개의 트랜잭션을 언두해야한다. 사가는 트랜잭션 역순으로 보상 트랜잭션을 실행한다.
    

---

## 사가 편성

사가를 편성하는 로직 종류

- **코레오그래피**: 의사 결정과 순서화를 사가 참여자에게 맡김. 사가 참여자는 주로 이벤트 교환 방식으로 통신
- **오케스트레이션**: 사가 편성 로직을 사가 오케스트레이션에 중앙화. 사가 오케스트레이터는 사가 참여자에게 커맨드 메세지를 보내 수행할 작업을 지시함.

### 코레오그래피

중앙 관리자가 없고, 사가 참여자가 서로 이벤트를 구독해서 그에 따라 반응.

*- 서비스간 순서 보장 질문

![image](https://user-images.githubusercontent.com/61832162/157372406-3e33178a-77b5-4798-ae6d-9536897eeec3.png)

Reference: [https://medium.com/trendyol-tech/saga-pattern-briefly-5b6cf22dfabc](https://medium.com/trendyol-tech/saga-pattern-briefly-5b6cf22dfabc)

### 오케스트레이션 사가

하나의 센터에서 **전체** 작업을 관리하는 오케스트레이터가 있다. 
오케스트레이션 사가는 사가 참여자가 할 일을 알려주는 오케스트레이터 클래스를 정의한다. 사가 참여자가 작업을 마치고 응답 메세지를 오케스트레이터에 주면, 오케스트레이터는 응답 메세지를 처리한 후 다음 사가 단계를 어느 참여자가 수행할지 결정

![image](https://user-images.githubusercontent.com/61832162/157372436-27c04b60-cc23-4031-94c3-06de17b2aa6a.png)

Reference: [https://medium.com/trendyol-tech/saga-pattern-briefly-5b6cf22dfabc](https://medium.com/trendyol-tech/saga-pattern-briefly-5b6cf22dfabc)

- 사가 오케스트레이터를 상태 기계로 모델링
    
    `state machine` , 는 상태와 이벤트에 의해 트리거가 되는 상태 전이(transition)로 구성된다.
    전이가 발생할 때마다, 액션이 일어나는데, 사가의 액션은 사가 참여자를 호출하는 작용이다.
    상태 간 전이는 시가 참여자가 로컬 트랜잭션을 완료하는 시점에 트리거되고, 로컬 트랜잭션 상태와 결과에 따라 어떤 액션을 취할지 결정된다.
    
- 사가 오케스트레이션과 트랜잭셔널 메세징
오케스트레이션 사가는 DB를 업데이트하는 서비스와 메세지를 발행하는 서비스가 단계마다 있다. 
서비스는 트랜잭셔널 메시지를 사용해서 DB 업데이트와, 메세지 발행을 `원자적`으로 처리해야한다.
- 오케스트레이션 사가의 장점
    - **의존 관계 단순화**
    오케스트레이터는 참여자를 호출하지만, 참여자는 오케스트레이터는 호출하지 않으므로 순환 참조가 발생하지 않는다.
    - **낮은 결합도**
    각 서비스는 오케스트레이터가 호출하는 API를 구현할 뿐, 시가 참여자가 발생하는 이벤트는 모른다
    - **관심사 분리, 비즈니스 로직 단순화**
    사가 편성 로직이 오케스트레이터 한 곳 있으므로 도메인 객체는 단순해지고, 자신이 참여한 사가에 대해서 모른다.
    

---

## 비격리 문제 처리

ACID의 격리성은 여러 트랜잭션이 어떤 순서로 실행되더라도 동일한 결과를 보장하는 속성이다. 사가는 격리성이 빠져있는데, 두 가지 문제점이 있다.

1. 한 사가가 실행 중에 접근하는 데이터를 도중에 다른 사가가 바꿔치기할 수 있다.
2. 한 사가가 업데이트를 하기 이전 데이터를 다른 사가가 읽을 수 있어서, 데이터 일관성 깨짐

- 비격리로 인한 비정상
    - 소실된 업데이트(lost update): 한 사가의 변경분을 다른 사가가 못 읽고 덮어씀
    - dirty read: 사가 업데이트를 하지 않은 변경분을 다른 트랜잭션이나, 사가가 읽음
    - Non-Repeatable read: 한 사가의 상이한 두 단계가 같은 데이터를 읽어도 결과가 달라지는 현상. (다른 사가가 그 사이에 업데이트)

### 비격리 대책

- 사가의 구조
    
    사가는 다음 세 가지 트랜잭션으로 구성된다.
    
    - **보상 트랜잭션**: 보상 트랜잭션으로 롤백 가능한 트랜잭션
    - **피봇 트랜잭션**: 사가의 진행/중단 지점. 피봇 트랜잭션이 커밋되면 사가는 완료될 때까지 실행된다. (좀 더 알아보기)
    - **재시도 가능 트랜잭션**: 피봇 트랜잭션 직후의 트랜잭션. 반드시 성공

1. 시맨틱 락

보상 가능한 트랜잭션이 생성/수정하는 레코드에 무조건 플래그를 세팅하는 대책. 레코드가 아직 커밋 전이라 변경될지 모른다는 표시하는 것. 플래그를 셋팅해서 다른 트랜잭션이 접근할때 lock을 걸어 놓거나, 경고를함.

1. 교환적 업데이트

업데이트를 교환적으로, 즉 어떤 순서든 실행 가능하게 설계하면 소실된 업데이트 문제를 방지할 수 있음.
ex) 계좌 인출 → 계좌 업데이트

1.  비관적 관점

더티 리드로 인한 리스크를 최소화 하기 위해 사가 단계의 순서를 재조정.

1. 값 다시 읽기

소실된 업데이트를 방지하는 대책. 사가가 레코드를 업데이트 하기 전에 값을 다시 읽어, 값이 변경되지 않았는지 확인한다. 다시 읽었는데 값이 변경되었으면, 사가를 중단하고 나중에 재시작한다.